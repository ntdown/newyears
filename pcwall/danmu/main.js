!function(n){var e=wwwdomain+"images/wall/unname.jpg",i=function(){this.walldanmuConfig=null,this.dm=null,this.curSort=0,this.openInterval=null,this.danmuLoop="Y",this.onWallSignIn=[],this.dbUtil=new Hi.DbUtil(flag,"msg")};i.prototype={init:function(){var i=n.Deferred(),t=this;return Hi.Note.r(Hi.Note.type.UPDATE_GLOBAL,function(n){function e(){for(var e=t.walldanmuConfig,a=n,o=0;o<arguments.length;o++){var l=arguments[o];e[l]!=a[l]&&i.push(l)}}if("walldanmuConfig"==n.noteType){var i=[];if(e("loop","style","position","fontsize","speed"),t.walldanmuConfig=n,1==i.length&&"speed"==i[0]){var a=document.body.clientWidth;t.dm.conf.minTime=a/parseFloat(n.speed)-1e3,t.dm.conf.maxTime=a/parseFloat(n.speed)+1e3}else t.initDanmu();t.danmuLoop=n.loop}}),Hi.Db.get("global","walldanmuConfig").then(function(n){t.walldanmuConfig=n,t.danmuLoop=n.loop,t.initDanmu(),i.resolve()},function(){console.error("查询失败")}),n("#danmu").click(function(){var i=n(this);if(i.hasClass("danmu-ban")){i.removeClass("danmu-ban").addClass("danmu-open"),n("#danmu-wall").fadeIn().css("opacity","1"),clearInterval(t.openInterval);var a=!1;t.openInterval=setInterval(function(){a||(a=!0,t.dbUtil.getMsg(t.onWallSignIn,"next",1).then(function(n){var i=n.shift();if(i){t.onWallSignIn[0]=i;var o=i.data;"text"===o.msgType&&(o.imgpath=o.imgPath?Hi.String.dealUrl(o.imgPath):e,t.dm.push(o))}else"Y"==t.danmuLoop&&(t.onWallSignIn=[]);a=!1},function(){a=!1,console.log("danmu error")}))},500)}else clearInterval(t.openInterval),t.openInterval=null,i.removeClass("danmu-open").addClass("danmu-ban"),n("#danmu-wall").css("opacity","0"),n(this).find(".msg").remove()}),i.promise()},initDanmu:function(){var i=this,t=i.walldanmuConfig,a=document.body.clientWidth,o=parseInt(t.fontsize.substring(0,2)),l={defaultHead:e,minTime:a/parseFloat(t.speed)-1e3,maxTime:a/parseFloat(t.speed)+1e3,position:t.position};"simple"==t.style?l.lineHeight=48==o?78:64:l.lineHeight=o+4,l.getMsgHtml=function(n){return"simple"==t.style?(html='<div class="simply simply'+Math.round(4*Math.random())+" font"+o+'">',html+='<img src="'+n.imgpath+'"><p>'+n.content+"</p></div>"):html='<div class="rough font'+o+" rough"+Math.round(4*Math.random())+'">'+n.content+"</div>",html},i.dm=n("#danmu-wall").danMu(l),i.dm.init()}};var t=new i;Hi.Activity.r("danmu",t),n(window).resize(function(){setTimeout(function(){if(t&&t.walldanmuConfig){dmWidth=document.body.clientWidth;var n=t.walldanmuConfig.speed;t.dm.conf.minTime=dmWidth/parseFloat(n)-1e3,t.dm.conf.maxTime=dmWidth/parseFloat(n)+1e3}},500)})}(jQuery);