!function(){function t(t){this.wall=t,this.wallmoneyConfig=null,this.partNum=0}Hi.Push.r("moneyGuestCount",function(t){var e=Hi.Activity.g("money");e.partNum=t,$(".part-num").html(e.partNum)}),Hi.Push.r("wallMoneyStart",function(t){Hi.Note.n(Hi.Note.type.WALL_MONEY_START,t)}),Hi.Push.r("mcToggleMoneyStart",function(t){$("#money-wall-block .money-play-box:visible #amout-moner:visible").trigger("click")}),Hi.Push.r("mcToggleMoneyNext",function(t){$("#money-wall-block #fight-result:visible .money-double").trigger("click")});var e=function(){$(document).bind("keyup.space",function(t){$("#amout-moner").is(":visible")&&$("#amout-moner:visible").click(),$(".money-double").is(":visible")&&$(".money-double:visible").click()}),$(document).bind("keyup.up",function(t){$("#prevGame").click()}),$(document).bind("keyup.down",function(t){$("#nextGame").click()})},n=function(){$(document).unbind("keyup.space"),$(document).unbind("keyup.up"),$(document).unbind("keyup.down")};t.prototype.init=function(){var t=$.Deferred(),e=this;Hi.Note.r(Hi.Note.type.UPDATE_GLOBAL,function(t){"wallmoneyConfig"==t.noteType&&(e.wallmoneyConfig=t,e.cacheList=[],$(".scale-user").empty(),e.control.show(),e.defaultTit.show(),e.stageResult.hide(),e.startDown.hide(),e.getGameSet())}),Hi.Note.r(Hi.Note.type.WALL_MONEY_START,function(t){e.active||$("#amout-moner").is(":visible")&&$("#amout-moner:visible").click()});var n=function(){var t=$.Deferred();return Hi.Db.get("global","wallmoneyConfig").then(function(n){e.wallmoneyConfig=n,Hi.Dc.query({where:{flag:flag}}).post("/web/wallmoney/signCount.html",function(n,a){a&&(e.partNum=a.totalCount),t.resolve()})},function(){console.error("查询失败")}),t.promise()},a=function(){var t=$.Deferred();return Hi.Load.moduleHtml("money").always(function(){t.resolve()}),t.promise()},o=function(){var t=$.Deferred();return e.control=$("#amout-moner"),e.joinUser=$("#money-wall-block .part-num"),e.defaultTit=$("#money-wall-block .stage-tite"),e.startDown=$(".amount-down-num"),e.timeDown=$(".amount-down-time"),e.countTotal=3,e.stageResult=$("#fight-result"),e.defaultWall=$(".money-play-box"),e.gameWall={},e.gameSet={},e.stageBefore=$(".money-play-box"),e.stageLuck=$("#fight-luck"),e.gameTime=$(".time-down-num"),e.timeDownTite=$("#courdown-tite"),e.interval=null,e.maxColumnH=280,e.cacheList=null,e.againDom=$(".money-double"),e.active=!1,e.playingAjax=null,e.LoadInit(),t.resolve(),t.promise()};return n().then(a).then(o).always(t.resolve),t.promise()},t.prototype.in=function(){var t=this;e(),$("#money-wall-block").show(),t.getGameSet(),$("#play-handle").hide(),$("#game-control-switch").css("display","inline"),$("#prevGame").bind("click",function(){Hi.Dc.query({where:{flag:flag,type:"up"}}).post("/web/wallmoney/moneySwitch.html",function(t,e,n){n.msg.length>0&&layer.msg(n.msg)})}),$("#nextGame").bind("click",function(){Hi.Dc.query({where:{flag:flag,type:"down"}}).post("/web/wallmoney/moneySwitch.html",function(t,e,n){n.msg.length>0&&layer.msg(n.msg)})})},t.prototype.leave=function(){n(),$("#money-wall-block").hide(),$("#wallcontrol .fr").hide(),$("#prevGame").unbind("click"),$("#nextGame").unbind("click"),this.stageResult.hide()},t.prototype.LoadInit=function(){this.stageResult.find(".result-user").hide(),this.eveBind()},t.prototype.eveBind=function(){var t=this;this.control.bind("click",function(){Hi.Dc.query({wallFlag:flag,moneyId:t.wallmoneyConfig.moneyId}).post("/web/wallmoney/moneyStartTime.html",function(e,n,a){Hi.Wall.checkState(),t.control.hide(),t.defaultTit.hide(),t.timeDown.text(t.countTotal),t.startDown.addClass("animation-scale").show(),t.startTime()})}),this.startDown.bind("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){t.startDown.removeClass("animation-scale")}),this.againDom.bind("click",function(){t.againDom.addClass("animate-rotate"),t.again()})},t.prototype.startTime=function(){var t=this;t.active=!0,Hi.Push.s({system:{cmd:"globalNote",secondCmd:"wallMoneyStart"},data:{moneyId:t.wallmoneyConfig.moneyId}}),Hi.Wall.unBindControl();var e=this.countTotal,n=this,a=setInterval(function(){e>0?(e--,n.timeDown.text(e),n.startDown.addClass("animation-scale")):e<=0&&(clearInterval(a),n.checkStart(),t.active=!1)},1e3)},t.prototype.checkStart=function(){var t=this;Hi.Dc.query({where:{wallflag:flag}}).post("/web/wallmoney/fight.html",function(e,n,a){t.cacheList=[],$(".scale-user").empty(),t.stageBefore.hide(),"speedTime"==t.gameWall.playWay&&(t.gameTime.text(t.gameSet.speedTimeTotal),t.stageLuck.show(),t.tagPlaying(),t.intervalData())})},t.prototype.commonAjax=function(t,e,n){Hi.Dc.query(t).post(e,function(t,e,a){e={dataContent:e,systemContent:a},n(e)})},t.prototype.getGameSet=function(){function t(t){t.systemContent.msg.length||(e.defaultTit.text(t.dataContent.wallmoney.title),e.gameWall=$.extend(e.gameWall,t.dataContent.wallmoney),e.upGameSet(t.dataContent.wallmoney.conf),e.timeDownTite.text(t.dataContent.wallmoney.title),"Finish"==t.dataContent.moneyState?e.wallResult():e.defaultWall.show())}this.joinUser.text(this.partNum);var e=this,n={where:{flag:flag}},a="/web/wallmoney/moneyRule.html";this.commonAjax(n,a,t)},t.prototype.wallResult=function(){function t(t){var n=t.dataContent;e.cacheList=e.arrSort(n,"count","number"),e.showResult()}var e=this,n="/web/wallmoney/result.html",a={where:{moneyId:this.gameWall.id}};this.commonAjax(a,n,t)},t.prototype.upGameSet=function(t){this.gameSet=$.extend(this.gameSet,t)},t.prototype.tagPlaying=function(){function t(){n>=0?(e.gameTime.text(n),n--,setTimeout(t,1e3)):(Hi.Wall.bindControl(),clearInterval(t),e.showResult())}var e=this,n=this.gameSet.speedTimeTotal;t()};var a=function(t){try{for(var e=new Map,n=0;n<t.length;n++){var a=t[n],o=a.moneyId+"-"+a.wxUserId,i=e.get(o);i?i.count<=a.count&&e.put(o,a):e.put(o,a)}return e.values()}catch(t){}return t};t.prototype.intervalData=function(){function t(t){if("normal"==t.dataContent.moneyState){var n=t.dataContent.wallmoneyRecordList;if(n.length){stortArr=a(n),stortArr=e.arrSort(stortArr,"count","number"),stortArr.sort(function(t,e){if(t.count==e.count){var n=new Date(t.lastDate).getTime(),a=new Date(e.lastDate).getTime();return n==a?t.wxUserId-e.wxUserId:n-a}return e.count-t.count}),e.cacheList=stortArr;for(var o="",i=0,l=stortArr.length>10?10:stortArr.length;i<l;i++){var r=stortArr[i].weixinUser,s=Hi.Wall.getSignUserName(r.id,r.nickName),m=r.imgpath?r.imgpath:wwwdomain+"images/wall/unname.jpg";o+='<div class="scale-user-list scale-list-'+(i+1)+'">',o+='<span class="gold-hd"></span>',o+='<span class="gold-main" style="height:'+stortArr[i].count/stortArr[0].count*e.maxColumnH+'px;"></span>',o+='<div class="gold-num">'+stortArr[i].count+"</div>",o+='<div class="player-img"><img src="'+Hi.String.dealUrl(m)+'"></div>',o+='<div class="player-name">'+s+"</div>",o+="</div>"}$(".scale-user").html(o)}setTimeout(function(){e.intervalData()},1e3)}else if("Finish"==t.dataContent.moneyState){var n=t.dataContent.wallmoneyRecords;n&&n.length>0&&(e.cacheList=n),e.showResult()}}var e=this,n="/web/wallmoney/userList.html",o={where:{flag:flag,moneyId:this.gameSet.moneyId}};this.commonAjax(o,n,t)},t.prototype.arrSort=function(t,e,n){if("number"==n)for(var a=0,o=t.length;a<o;a++)for(var i=0,l=t.length;i<l;i++)if(a!=i&&t[i][e]<t[a][e]){var r=t[a];t[a]=t[i],t[i]=r}return t},t.prototype.showResult=function(){if(this.stageLuck.hide(),this.stageResult.show(),this.defaultWall.hide(),this.stageResult.find(".result-user").hide(),this.cacheList&&this.cacheList.length)for(var t=this.gameWall.rank<this.cacheList.length?this.gameWall.rank:this.cacheList.length,e=0;e<t;e++){var n=this.cacheList[e].weixinUser,a=Hi.Wall.getSignUserName(n.id,n.nickName),o=$(".result-"+(e+1)),i=n.imgpath?n.imgpath:"/images/wall/unname.jpg";o.find(".result-user-img img").attr("src",Hi.String.dealUrl(i)),o.find(".raking").html(e+1),o.find(".name-string").html(a),o.find(".result-user-currency").html(this.cacheList[e].count+this.gameSet.speedTimeLimitUnit),o.show()}},t.prototype.again=function(){function t(t){e.againDom.removeClass("animate-rotate"),e.startDown.hide(),e.control.show(),e.defaultTit.show(),e.stageLuck.find(".scale-user").html(" ")}var e=this,n="/web/wallmoney/nextRound.html",a={where:{flag:flag}};this.commonAjax(a,n,t)};var o=new t;Hi.Activity.r("money",o)}(jQuery);