!function(){Hi.Push.r("wallShakeprizeStart",function(e){Hi.Note.n(Hi.Note.type.WALL_SHAKEPRIZE_START,e)}),Hi.Push.r("mcToggleShakePrizeStart",function(e){var i=$("#shakeprize-wall-block .start").find("a");i&&i.length&&i.is(":visible")&&i.click()}),Hi.Push.r("updateWallShakeprizeRegedit",function(e){var i=e.count;i&&($("#shakeRegeditNum").html(i),Hi.Activity.g("shakeprize").regeditCount=i)});var e=function(){$(document).bind("keyup.space",function(e){var i=$("#shakeprize-wall-block .start").find("a");i&&i.length&&i.is(":visible")&&i.click()}),$(document).bind("keyup.up",function(e){$("#prevGame").click()}),$(document).bind("keyup.down",function(e){$("#nextGame").click()})},i=function(){$(document).unbind("keyup.space"),$(document).unbind("keyup.up"),$(document).unbind("keyup.down")},t=function(e){this.wall=e,this.wallshakeprizeConfig=null,this.winnerList=[],this.countdown=60,this.downGiftTimer=null,this.state="NotStarted",this.active=!1,this.regeditCount=0};t.prototype.init=function(e){var i=$.Deferred(),t=this;return Hi.Note.r(Hi.Note.type.UPDATE_GLOBAL,function(e){if("wallshakeprizeConfig"==e.noteType){var i=!1;t.wallshakeprizeConfig.shakeprizeId!=e.shakeprizeId&&"shakeprize"==Hi.Activity.currentActivity&&(i=!0),t.wallshakeprizeConfig=e,t.countdown=t.wallshakeprizeConfig.wallshakeprize.shakeTime,i&&(t.leave(),t.in()),t.refreshShakeprizeRegeditCount(function(){$("#shakeRegeditNum").html(t.regeditCount)})}}),Hi.Note.r(Hi.Note.type.WALL_SHAKEPRIZE_START,function(e){t.wallshakeprizeConfig.shakeprizeId==e.shakeprizeId&&t.go()}),Hi.Db.get("global","wallshakeprizeConfig").then(function(e){t.wallshakeprizeConfig=e,t.wallshakeprizeConfig&&t.wallshakeprizeConfig.wallshakeprize&&(t.countdown=t.wallshakeprizeConfig.wallshakeprize.shakeTime,t.refreshShakeprizeRegeditCount(function(){i.resolve()}))},function(){console.error("查询失败")}),i.promise()},t.prototype.in=function(){$("#wallNote,#wallcopyright").css("visibility","hidden");var i=this,t=!0;i.active=!1;var a=function(){var e="",a=$("#shakeprize-wall-block .shakeprize"),n="";Hi.Db.get("global","wall").then(function(l){n="NoBound"==l.type?"点击互动按钮参与"+i.wallshakeprizeConfig.wallshakeprize.title:"发送“"+i.wallshakeprizeConfig.keyword+"”参与"+i.wallshakeprizeConfig.wallshakeprize.title,e+='<div class="start"><div class="curpeople">参与人数：<span id="shakeRegeditNum">'+i.regeditCount+"</span>人</div>",e+='<div class="startxt"><a href="javascript:void(0);">马上开始</a></div>',e+='<div class="title">'+n+"</div></div>",a.empty().append(e),a.find("a").bind("click",function(){Hi.Wall.checkState(),"In"==l.activeState&&(t&&(i.start(),t=!1),setTimeout(function(){t=!0},2e3))})},function(){console.error("查询失败")})};e(),$("#play-handle").hide(),$("#game-control-switch").css("display","inline"),$("#prevGame").bind("click",function(){Hi.Dc.query({where:{flag:flag,type:"up"}}).post("/web/wallshakeprize/switchShakePrize.html",function(e,i,t){t.msg.length>0&&layer.msg(t.msg)})}),$("#nextGame").bind("click",function(){Hi.Dc.query({where:{flag:flag,type:"down"}}).post("/web/wallshakeprize/switchShakePrize.html",function(e,i,t){t.msg.length>0&&layer.msg(t.msg)})}),$("#shakeRegeditNum").html(i.regeditCount),Hi.Dc.query({where:{flag:flag,shakeprizeId:i.wallshakeprizeConfig.shakeprizeId}}).post("/web/wallshakeprize/record.html",function(e,t,n){"Right"==n.state?(i.state=t.state,i.wallShakeprizeRanking=t.winList,i.wallShakeprizeRanking.length>0?i.finish():a(),$("#shakeprize-wall-block").show()):layer.alert(n.msg)})},t.prototype.leave=function(){var e=this;$("#shakeprize-wall-block").hide(),$("#wallNote,#wallcopyright").css("visibility","visible"),e.wallShakeprizeRanking=[],i(),$("#wallcontrol .fr").hide(),$("#prevGame").unbind("click"),$("#nextGame").unbind("click")},t.prototype.refreshShakeprizeRegeditCount=function(e){var i=this;Hi.Dc.query({where:{wallId:wallJson.id,shakeprizeId:i.wallshakeprizeConfig.shakeprizeId}}).post("/web/wallshakeprizeRegedit/count.html",function(t,a,n){try{var a=a;a.shakeprizeId==i.wallshakeprizeConfig.shakeprizeId&&(i.regeditCount=a.count)}catch(e){}e&&e()})},t.prototype.start=function(){var e=this;Hi.Wall.unBindControl(),Hi.Dc.query({where:{flag:flag}}).post("/web/wallshakeprize/go.html",function(i,t,a){i&&layer.msg("网络错误，请刷新重试！"),"Right"==a.state?(Hi.Push.s({system:{cmd:"globalNote",secondCmd:"wallShakeprizeStart"},data:{shakeprizeId:e.wallshakeprizeConfig.shakeprizeId}}),e.go()):layer.msg(a.msg)})},t.prototype.go=function(){var e=this,i="";e.active||(e.active=!0,e.state="In",i+='<div id="downLottery"></div>',i+='<div id="lotteryPerson">',i+="<ul><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul></div>",$("#shakeprize-wall-block .shakeprize").empty().append(i),e.refreshWinList(function(){e.finish(),clearInterval(e.downGiftTimer)}),e.animation(),e.downGift(),e.timer())},t.prototype.refreshWinList=function(e){var i=this,t=function(){var e=!0;Hi.Dc.query({where:{flag:flag,shakeprizeId:i.wallshakeprizeConfig.shakeprizeId}}).post("/web/wallshakeprize/record.html",function(t,n,l){"Right"==l.state&&(i.state=n.state,i.wallShakeprizeRanking=n.winList,"End"!=i.state&&"NotStarted"!=i.state||(e=!1)),a(e)})},a=function(i){i?setTimeout(function(){t()},2e3):e&&e()};t()},t.prototype.timer=function(){function e(){if(!(a>0))return!1;a--;var i=a*r*l+t;$(".timer-main").css("width",i+"px"),a<n&&($(".timer-main").hasClass("orange-bg")||$(".timer-main").addClass("orange-bg")),setTimeout(function(){e()},1e3)}var i=this,t=30,a=i.countdown,n=.3*a,l=970,r=1/a,s="";s+='<div id="timer">',s+='<div class="timer-main">',s+='<div class="timer-obj"><img src="/images/wall/timergift.png"></div>',s+="</div></div>",$("#downLottery").prepend(s),e()},t.prototype.downGift=function(){function e(){return a[Math.floor(6*Math.random())]}function i(){var i=e();return"/images/wall/linepocket.png"==i||"/images/wall/pocketline.png"==i?$('<div class="giftbox2">').css("background-image","url("+i+")").addClass("downgift"):$('<div class="giftbox">').css("background-image","url("+i+")").addClass("downgift")}var t=this,a=["/images/wall/gift.png","/images/wall/hongbao.png","/images/wall/hongbao2.png","/images/wall/linepocket.png","/images/wall/gift.png","/images/wall/pocketline.png"],n=$(".shakeprize");realWidth=n.width(),realHeight=n.height();var l=$("#downLottery");t.downGiftTimer=setInterval(function(){var e=Math.random()*(realWidth+400),t=(1500*Math.random(),i());t.css("left",e),l.append(t),setTimeout(function(){t.remove()},1e3)},80)},t.prototype.animation=function(){var e=this,i=$(".shakeprize"),t=[],a=function(){if("End"!==e.state){var n=t.shift();if(!n)return void setTimeout(function(){var i=e.wallShakeprizeRanking;i.length&&(i.sort(function(e,i){return e.id-i.id}),[].slice.call(i).forEach(function(e){e&&e.weixinUser&&($('#lotteryPerson ul li[data-id="'+e.weixinUser.id+'"]').length||t.push(e))})),a()},1e3);var l=Math.random()*(i.width()-200)+"px",r=Math.random()*(i.height()-360)+"px",s=n.weixinUser,o=Hi.Wall.getSignUserName(s.id,s.nickName),p='<div data-id="'+s.id+'" class="bomb" style="left:'+l+";top:"+r+';"><img src="/images/wall/starbomb.gif" /></div>',c="";c+='<img class="hongbao" src="/images/wall/redholder.png">',c+='<img class="headimg" src="'+s.imgpath+'">',c+='<p class="nickname">'+o+"</p>",i.append(p),setTimeout(function(){var e=null;$("#lotteryPerson").length&&($("#lotteryPerson ul li:not(.winner)").length?e=$("#lotteryPerson ul li:not(.winner)")[0]:($("#lotteryPerson ul li").first().remove(),$("#lotteryPerson ul").append("<li></li>"),e=$("#lotteryPerson ul li").last()),$(".bomb").empty().append(c).animate({left:$(e).offset().left-$("#downLottery").offset().left+"px",top:$(e).offset().top-$("#downLottery").offset().top+"px",opacity:0},{easing:"easeInExpo",duration:1e3,complete:function(){$(e).addClass("winner").attr("data-id",s.id).append(c),$(".bomb").remove(),a()}}))},500)}};a()},t.prototype.finish=function(){var e=this,i="",t={},a=e.wallShakeprizeRanking,n=a.length,l=e.wallshakeprizeConfig.wallshakeprize.awardsList;a.sort(function(e,i){return e.id-i.id}),[].slice.call(l).forEach(function(e){t[e.id]=e}),Hi.Wall.bindControl(),i+='<div class="prizelist"><h3 class="prizelist-h3">'+e.wallshakeprizeConfig.wallshakeprize.title+"<sup>中奖名单</sup></h3>",i+=n>0&&n<6?'<ul class="prize-ul big">':n<11&&n>5?'<ul class="prize-ul middle">':0===n?'<ul class="prize-ul">':'<ul class="prize-ul small">',[].slice.call(a).forEach(function(e){var a=t[e.awardsId],n=e.weixinUser,l=a.prizeType,r=Hi.Wall.getSignUserName(n.id,n.nickName);i+=n.imgpath?'<li><img class="head" src="'+Hi.String.dealUrl(n.imgpath)+'">':'<li><img class="head" src="/images/wall/unknow.png">',i+='<div class="cont"><p class="nickname">'+r+"</p>",i+="kind"==l?'<p class="info">'+a.prizeName+"</p>":'<p class="info">现金红包<span>'+a.prizeCount/100+"</span>元</p>",i+="</div></li>"}),i+="</ul></div>",$("#shakeprize-wall-block .shakeprize").empty().append(i)};var a=new t;Hi.Activity.r("shakeprize",a)}(jQuery);