!function(t){function n(){t(document).bind("keyup.space",function(n){var e=t("#redpack-wall-block");e.length>0&&e.find(".nostart").is(":visible")&&t("#cotrol-start").click()}),t(document).bind("keyup.up",function(n){t("#prevGame").click()}),t(document).bind("keyup.down",function(n){t("#nextGame").click()})}function e(){t(document).unbind("keyup.space"),t(document).unbind("keyup.up"),t(document).unbind("keyup.down")}function i(){this.wallConfig=null,this.redpackConfig=null,this.contain=null,this.winerHide=null,this.alreadyWiner=[],this.alreadyWinerIndet=0,this.cacheAlready={},this.winerMsgTop=0,this.intervalGetWin=!0,this.playConfig=null,this.active=!0,this.firstInit=!0}function o(t,n){var e=n-t+1;return Math.floor(Math.random()*e+t)}function a(n,e){var i=template("win-msg",e);return $html=t(i),this.setWiner=this.sinRound(10,50,n),$html.css("top",this.setWiner+"%"),{html:$html[0],top:this.setWiner}}Hi.Push.r("wallRedpackStart",function(t){Hi.Note.n(Hi.Note.type.WALL_REDPACK_START,t)}),i.prototype.init=function(){var n=this;Hi.Note.r(Hi.Note.type.WALL_REDPACK_START,function(e){n.active||t("#redpack-wall-block").is(":visible")&&t("#cotrol-start").click()}),Hi.Note.r(Hi.Note.type.UPDATE_GLOBAL,function(t){"wallredpackConfig"==t.noteType&&n.playConfig&&n.playConfig.id!=t.wallredpack.id&&"redpack"==Hi.Activity.currentActivity&&(n.playConfig=t.wallredpack,n.switchInit(t.wallredpack))});var e=function(){var e=t.Deferred();return t.post("/wall/temp/defaults/wall-html-redpack.html",function(i){t("body").append(i),n.contain=t("#redpack-wall-block"),"Y"!=n.wallConfig.enterprise&&n.contain.find(".redpack-hi-ico").show(),e.resolve()}),e.promise()},i=function(){var e=t.Deferred();return Hi.Db.get("global","wall").then(function(t){console.log(),n.wallConfig=t,e.resolve()},function(){console.error("查询失败")}),e.promise()},o=t.Deferred();return i().then(e).then(o.resolve,o.reject),o.promise()},i.prototype.in=function(){function e(){var n=i.contain.find("img"),e=0;n.each(function(){var o=t(this).attr("src"),a=new Image;a.onload=function(){e++,e==n.length&&i.resize()},a.src=o})}var i=this;this.contain.show(),this.updateKeyword(),this.getGameConfig(),i.contain.hasClass("loaded")?this.resize():(e(),i.contain.addClass("loaded")),t("#play-handle").hide(),t("#game-control-switch").css("display","inline"),this.bindEve(),n()},i.prototype.leave=function(){this.contain.hide(),this.unbind(),e(),t("#game-control-switch").css("display","none")},i.prototype.getGameConfig=function(){var t=this;Hi.Dc.query({where:{flag:flag}}).post("/web/wallredpack/read.html",function(n,e,i){t.playConfig=e,"NotStarted"!=e.state&&"Show"!=e.state||(t.active=!1,t.firstInit=!1,t.switchInit(e)),"In"==e.state&&(t.active=!0,t.firstInit=!0,t.contain.find(".round-text").text(e.title),t.contain.find(".sended").children(".send-number").text(e.sendCount),t.switchStart()),"Finish"==e.state&&t.getWiner()})},i.prototype.updateKeyword=function(){var t=this;Hi.Db.get("global","wallredpackConfig").then(function(n){t.redpackConfig=n,"NoBound"==t.wallConfig.type?t.contain.find(".plays-note").text("手机端点击“互动-摇红包”参与"):t.contain.find(".plays-note").text("手机端发送“"+t.redpackConfig.keyword+"”参与")},function(){console.error("查询失败")})},i.prototype.countDown=function(){function n(){i>0?(t(".packets-count-down").html('<span class="count-animate">'+i+"</span>"),i--,setTimeout(function(){n()},1e3)):(t(".packets-count-down").html('<span class="count-animate">GO</span>'),setTimeout(function(){t(".packets-count-down").remove(),e.switchStart()},1e3))}var e=this;this.active=!0,Hi.Push.s({system:{cmd:"globalNote",secondCmd:"wallRedpackStart"},data:{state:"In"}}),this.contain.append('<div class="packets-count-down"></div>');var i=5;n()},i.prototype.startControl=function(){var t=this;Hi.Dc.query({where:{flag:flag}}).post("/web/wallredpack/start.html",function(n,e,i){return n?(layer.msg(n.msg,{time:3e3}),!1):void t.countDown()})},i.prototype.switchInit=function(t){this.intervalGetWin=!0,this.alreadyWiner=[],this.alreadyWinerIndet=0,this.updateKeyword(),this.contain.find(".round-text").text(t.title),"NotStarted"==t.state?(this.contain.find(".nostart").show(),this.contain.find(".ing-packet").hide(),this.contain.find(".not-send").show(),this.contain.find(".sended").hide(),this.contain.find(".not-send").find(".send-number").text(t.redpackCount),this.contain.find(".packets-result").hide()):"Finish"==t.state&&this.getWiner()},i.prototype.switchStart=function(){Hi.Wall.unBindControl(),t(".not-send").hide(),t(".sended").show(),t(".nostart").hide(),t(".ing-packet").addClass("animation").show(),this.getWiner()},i.prototype.getWiner=function(){var t=this;return!!t.intervalGetWin&&void Hi.Dc.query({where:{flag:flag}}).post("/web/wallredpack/info.html",function(n,e,i){var o=e.wallredpackRecord;if(o.length>0){for(var a=!1,r=0;r<o.length;r++)t.cacheAlready[o[r].id]||(t.alreadyWiner.push(o[r]),t.cacheAlready[o[r].id]=o[r],a=!0);a&&!t.firstInit?t.userWiner(t.alreadyWiner[t.alreadyWiner.length-1]):t.updateWinMsg(),t.firstInit=!1}t.contain.find(".sended").find(".send-number").text(t.alreadyWiner.length),"Finish"==e.state?(t.intervalGetWin=!1,t.getResult(e.wallredpackRecord)):"In"==e.state&&setTimeout(function(){t.getWiner()},1e3)})},i.prototype.bindEve=function(){var n=this;t("#cotrol-start").click(function(){n.startControl()}),t("#control-playend").click(function(){n.endPacker()}),t("#prevGame").bind("click",function(){Hi.Dc.query({where:{flag:flag,type:"up"}}).post("/web/wallredpackConfig/switch.html",function(t,n,e){t&&layer.msg(t.msg)})}),t("#nextGame").bind("click",function(){Hi.Dc.query({where:{flag:flag,type:"down"}}).post("/web/wallredpackConfig/switch.html",function(t,n,e){t&&layer.msg(t.msg)})})},i.prototype.unbind=function(){t("#cotrol-start").unbind("click"),t("#control-playend").unbind("click"),t("#prevGame").unbind("click"),t("#nextGame").unbind("click")},i.prototype.userWiner=function(n){var e=this,i=template("winner",n);t(".has-winner").remove(),this.contain.find(".ing-cont").append(i),this.winerHide=setTimeout(function(){t(".has-winner").remove(),e.updateWinMsg()},3e3)},i.prototype.updateWinMsg=function(){var n=this;if(!n.intervalGetWin)return!1;if(this.alreadyWinerIndet<=this.alreadyWiner.length-1){var e=new a(n.winerMsgTop,this.alreadyWiner[this.alreadyWinerIndet]),i=n.contain.find(".winner-msg").length;i>=150&&n.contain.find(".winner-msg").eq(0).remove();var r=t(e.html),s=o(3e3,15e3);r.css("animation-duration",s+"ms");var c=o(7,10);r.css("transform","scale("+c/10+")"),r.css("z-index",c),n.contain.find(".g-packets-box").append(r),this.alreadyWinerIndet++,n.winerMsgTop=e.top,setTimeout(function(){n.intervalGetWin&&n.updateWinMsg()},1500)}},i.prototype.endPacker=function(){var t=layer.confirm("确认结束红包活动",{btn:["取消","确认"]},function(){layer.close(t)},function(){Hi.Dc.query({where:{flag:flag}}).post("/web/wallredpack/over.html",function(t,n,e){if(t)return!1})})},i.prototype.getResult=function(n){Hi.Wall.bindControl();var e=this;this.intervalGetWin=!1,n="random"==this.playConfig.type?n.sort(function(t,n){return n.money-t.money}):n.sort(function(t,n){var e=new Date(t.updateDate).getTime(),i=new Date(n.updateDate).getTime();return e-i});var i=template("result-list",{type:this.playConfig.type,list:n});e.contain.find(".result-rank-list").html(i),t(".ing-packet").removeClass("animation"),e.contain.find(".winner-msg").remove(),e.contain.find(".packets-result").show()},i.prototype.resize=function(){var t=this;window.extendResize=null,window.onresize||(window.extendResize=window.onresize),window.onresize=function(){window.extendResize&&window.extendResize(),t.contain.is(":visible")&&t.redpackResize()},t.redpackResize()},i.prototype.redpackResize=function(){var t=document.documentElement.clientHeight||document.body.clientHeight,n=this.contain.find(".red-packets-content")[0].clientHeight;console.log("height",t,n),this.contain.find(".red-packets-content").css({"transform-origin":"center top",transform:"scaleY("+t/n+")"})},a.prototype.sinRound=function(t,n,e){var i=o(t,n);return i>e-10&&i<e+10?tol=this.sinRound(t,n,e):i};var r=new i;Hi.Activity.r("redpack",r)}(jQuery);